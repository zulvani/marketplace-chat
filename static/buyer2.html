<html>
	<head>
		<title>Buyer</title>
		<!-- // <script src="socket.io/socket.io.js"></script> -->
		<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
		<script src="../libs/socket.io-client/socket.io.js"></script>
		<script src="../libs/mchat.js"></script>

		<script>
		var socket = new io('http://localhost:3000');
		var isActive; // is user on this browser or not
		var currentMessage = '';

		$(document).ready(function(){
			var buyer = {'id': 4, 'name': 'An Jung Huwa 2', 'socketId': '', 'type': entityType.BUYER};
			var seller = {'id': 3, 'name': 'Blanja Shop 2', 'socketId': '', 'type': entityType.SELLER};

			socket.emit('isSellerOnline', seller);
			socket.emit('memberConnect', seller, buyer, 'buyer');

			socket.on('memberConnected', function(member){
				buyer.socketId = member.socketId;
			});

			socket.on('updateSellerStatus', function(online){
				if(online){
					$('#seller').text('Online');
					$('#seller-online-wrapper').show();
				}
				else{
					$('#seller').text('Offline');
					$('#seller-online-wrapper').hide();
				}
			});

			socket.on('chatMessage', function(message){
				currentMessage = messages;

				$('#chat-history > ul').append(
					'<li id="message-'+message.id+'">[' + message.from.name + '] ' + message.content + '</li>');
				$('#message').val('');

				socket.emit('chatMessageReceived', message);

				// @TODO
				// if(isActive){
				var readMessages = [message];
				socket.emit('chatMessageRead', readMessages);
				// }
			});

			socket.on('chatMessageReceived', function(message){
				if(message.state === messageState.RECEIVED){
					$('#message-' + message.id).css('color', '#000');
				}
			});

			socket.on('chatMessageRead', function(messages){
				for(i in messages){
					var message = messages[i];
					if(message.state === messageState.READ){
						$('#read-message-' + message.id).show();
					}
				}
			});

			socket.on('typing', function(seller, buyer, from){
				$('#typing').show();
			});

			socket.on('stop-typing', function(seller, buyer, from){
				$('#typing').hide();
			});

			// --------------- DOM EVENT ------------------------

			$('#open-chat').click(function(){
				socket.emit('openChat', seller, buyer);
				$('#chat-wrapper').show();
				$('#seller-identity').text(seller.name);
			});

			$('#send-message').click(function(){
				sendMessage();
			});

			$('#message').keypress(function(e) {
    			if(e.which == 13) {
        			sendMessage();
    			}
			});

			$('#message').keydown(function(e) {
    			socket.emit('typing', seller, buyer, 'buyer');
			});

			$('#message').keyup(function(e) {
				delay(function(){
      				socket.emit('stop-typing', seller, buyer, 'buyer');
    			}, delayTypeTime );
			});

			// $('#message').focus(function(e) {
   //  			isActive = true;
			// });

			// $('#message').blur(function(e) {
   //  			isActive = false;
			// });

			// window.onfocus = function () { alert('focus'); isActive = true; }; 
			// window.onblur = function () { alert('blur'); isActive = false; };

			// ------------------------- FUNCTION ------------------------

			var sendMessage = function(){
				var contentMessage = $('#message').val();
				var message = constructMessage(contentMessage, buyer, seller);
				
				socket.emit('chatMessage', message);
				message.state = messageState.SENT_BY_CLIENT;
				message.sentByClientDate = new Date().getTime();

				$('#chat-history > ul').append(
					'<li id="message-' + message.id + '" style="color: #ccc">' +
						'[' + buyer.name + '] ' + contentMessage + 
					'<span id="read-message-' + message.id + '" style="color: green;display: none;font-weight: bold;">R</span>' +
					'</li>');

				$('#message').val('');
				socket.emit('stop-typing', seller, buyer, 'buyer');
			}
		});
		</script>
	</head>
	<body>
		<table width="100%">
			<tr>
				<td width="50%"><div id="messages"></div></td>
				<td width="50%">
					<div id="seller"></div>
				</td>
			</tr>
		</table>
		<div id="seller-online-wrapper" style="display:none">
			<input type="button" id="open-chat" value="Chat"/>
		</div>
		<div id="chat-wrapper" style="display:none">
			<h3 id="seller-identity"></h3><span id="typing" style="font-style: italic;display:none">Typing...</span>
			<div style="height: 300px; width: 500px;border: 1px #ccc solid;" id="chat-history">
				<ul>
				</ul>
			</div>
			<input type="text" id="message"/>&nbsp;<input type="button" id="send-message" value="Send"/>
		</div>
	</body>
</html>